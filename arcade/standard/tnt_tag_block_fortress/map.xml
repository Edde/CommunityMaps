<map proto="1.4.2">
<name>TNT Tag: Block Fortress</name>
<version>1.1.0</version>
<objective>Pass the TNT to another player before it explodes!</objective>
<gamemode>arcade</gamemode>
<gamemode>ffa</gamemode>
<authors>
    <author uuid="2a289d2a-d970-49c5-9a6c-01fc0264e317"/> <!-- Stealth5061 -->
    <author uuid="ef4ea031-998f-4ec9-b7b6-1bdd428bcef8"/> <!-- Plastix -->
</authors>
<contributors>
    <contributor uuid="f690a591-348b-482e-a18d-7779d0c0a28c" contribution="TNT Tag XML"/> <!-- mitchiii -->
</contributors>
<time>5m</time>
<blitz/>
<players max="64"/>
<kits>
    <kit id="tnt-kit" force="true">
        <game-mode>adventure</game-mode>
        <helmet material="tnt" locked="true"/>
        <chestplate material="leather chestplate" color="993333" locked="true" unbreakable="true"/>
        <leggings material="leather leggings" color="993333" locked="true" unbreakable="true"/>
        <boots material="leather boots" color="993333" locked="true" unbreakable="true"/>
        <item slot="0" material="tnt" locked="true"/>
        <item slot="1" material="tnt" locked="true"/>
        <item slot="2" material="tnt" locked="true"/>
        <item slot="3" material="tnt" locked="true"/>
        <item slot="4" material="compass"/>
        <item slot="5" material="tnt" locked="true"/>
        <item slot="6" material="tnt" locked="true"/>
        <item slot="7" material="tnt" locked="true"/>
        <item slot="8" material="tnt" locked="true"/>
        <effect amplifier="127">resistance</effect>
        <effect>speed</effect>
    </kit>
    <kit id="tnt-flash-kit" force="true">
        <game-mode>adventure</game-mode>
        <helmet material="snow block" name="`rTNT" locked="true"/>
        <chestplate material="leather chestplate" color="ffffff" locked="true" unbreakable="true"/>
        <leggings material="leather leggings" color="ffffff" locked="true" unbreakable="true"/>
        <boots material="leather boots" color="ffffff" locked="true" unbreakable="true"/>
        <item slot="0" material="snow block" name="`rTNT" locked="true"/>
        <item slot="1" material="snow block" name="`rTNT" locked="true"/>
        <item slot="2" material="snow block" name="`rTNT" locked="true"/>
        <item slot="3" material="snow block" name="`rTNT" locked="true"/>
        <item slot="4" material="compass"/>
        <item slot="5" material="snow block" name="`rTNT" locked="true"/>
        <item slot="6" material="snow block" name="`rTNT" locked="true"/>
        <item slot="7" material="snow block" name="`rTNT" locked="true"/>
        <item slot="8" material="snow block" name="`rTNT" locked="true"/>
        <effect amplifier="127">resistance</effect>
        <effect>speed</effect>
    </kit>
    <kit id="tnt-kill" force="true">
        <clear effects="true"/>
        <effect amplifier="50">instant damage</effect>
    </kit>
    <kit id="hider-kit">
        <clear effects="true"/>
        <game-mode>adventure</game-mode>
        <effect amplifier="127">resistance</effect>
    </kit>
</kits>
<compass show-distance="true">
    <player filter="is_tnt=0" show-player="true"/>
</compass>
<spawns>
    <spawn region="center-spawn" safe="true"/>
    <default yaw="180">
        <regions>
            <cuboid min="-2,23,-48" max="2,23,-52"/>
        </regions>
    </default>
</spawns>
<filters>
    <match-started id="match-started"/>
    <participating id="participating"/>
    <players id="count-xs" filter="participating" max="3"/>
    <players id="count-sm" filter="participating" min="4" max="5"/>
    <players id="count-md" filter="participating" min="6" max="11"/>
    <players id="count-lg" filter="participating" min="12" max="19"/>
    <players id="count-xl" filter="participating" min="20" max="29"/>
    <players id="count-xxl" filter="participating" min="30"/>
    <after id="round-idle-end" duration="1s" filter="round_state=0"/>
    <after id="round-starting" duration="3s" filter="round_state=1" message="The next round begins in {0}"/>
    <variable id="round-begin" var="round_state">2</variable>
    <any id="round-end">
        <after id="round-lg-end" duration="45s" message="TNT explodes in {0}">
            <all id="round-lg-begin">
                <any>
                    <filter id="count-xxl"/>
                    <filter id="count-xl"/>
                </any>
                <variable var="round_state">2</variable>
            </all>
        </after>
        <after id="round-md-end" duration="25s" message="TNT explodes in {0}">
            <all id="round-md-begin">
                <any>
                    <filter id="count-lg"/>
                    <filter id="count-md"/>
                </any>
                <variable var="round_state">2</variable>
            </all>
        </after>
        <after id="round-sm-end" duration="15s" message="TNT explodes in {0}">
            <all id="round-sm-begin">
                <any>
                    <filter id="count-sm"/>
                    <filter id="count-xs"/>
                </any>
                <variable var="round_state">2</variable>
            </all>
        </after>
    </any>
    <any id="start-tnt-fuse">
        <after duration="40s" filter="round-lg-begin"/>
        <after duration="20s" filter="round-md-begin"/>
        <after duration="10s" filter="round-sm-begin"/>
    </any>
    <attacker id="attacker-is-tnt">
        <variable id="is-tnt" var="is_tnt">1</variable>
    </attacker>
    <victim id="victim-is-hider">
        <variable id="is-hider" var="is_tnt">0</variable>
    </victim>
</filters>
<regions>
    <cylinder id="center-spawn" base="0,2,0" radius="3" height="1"/>
    <apply block="never"/>
    <apply leave="never">
        <region>
            <rectangle min="-32,-32" max="32,32"/>
        </region>
    </apply>
</regions>
<portals>
    <portal forward="all(participating, round-begin, any(count-xs, count-sm))" destination="center-spawn" sound="false"/>
</portals>
<variables scope="player">
    <variable id="start_tnt_xs" exclusive="1"/>
    <variable id="start_tnt_sm" exclusive="2"/>
    <variable id="start_tnt_md" exclusive="3"/>
    <variable id="start_tnt_lg" exclusive="5"/>
    <variable id="start_tnt_xl" exclusive="8"/>
    <variable id="start_tnt_xxl" exclusive="12"/>
    <variable id="is_tnt" default="0"/>
    <variable id="tnt_fuse" default="0" scope="match"/>
    <variable id="tmp" default="0" scope="match"/>
    <variable id="round" default="0" scope="match"/>
    <variable id="round_state" default="0" scope="match"/>
    <variable id="round_deathmatch" default="0" scope="match"/>
    <!--
    0: idle
    1: starting
    2: running
    -->
</variables>
<actions>
    <!--
      Utils
    -->
    <action id="pick-next-tnt" scope="match">
        <switch-scope inner="player" filter="participating">
            <set var="start_tnt_xs" value="1"/>
            <set var="start_tnt_sm" value="1"/>
            <set var="start_tnt_md" value="1"/>
            <set var="start_tnt_lg" value="1"/>
            <set var="start_tnt_xl" value="1"/>
            <set var="start_tnt_xxl" value="1"/>
        </switch-scope>
    </action>
    <action id="distribute-tnt-kits" scope="match">
        <action filter="count-xs">
            <set var="tmp" value="1"/>
        </action>
        <action filter="count-sm">
            <set var="tmp" value="2"/>
        </action>
        <action filter="count-md">
            <set var="tmp" value="3"/>
        </action>
        <action filter="count-lg">
            <set var="tmp" value="5"/>
        </action>
        <action filter="count-xl">
            <set var="tmp" value="8"/>
        </action>
        <action filter="count-xxl">
            <set var="tmp" value="12"/>
        </action>
        <switch-scope inner="player" filter="participating">
            <action filter="any(all(count-xs, start_tnt_xs=1), all(count-sm, start_tnt_sm=1), all(count-md, start_tnt_md=1), all(count-lg, start_tnt_lg=1), all(count-xl, start_tnt_xl=1), all(count-xxl, start_tnt_xxl=1))">
                <action id="become-tnt"/>
            </action>
        </switch-scope>
    </action>
    <action id="round-begin-message" scope="match">
        <message text=" "/>
        <action filter="round_deathmatch=0">
            <message text="`b`l» Round {num} has started!">
                <replacements>
                    <decimal id="num" value="round"/>
                </replacements>
            </message>
        </action>
        <action filter="round_deathmatch=1..">
            <message text="`d» `lDeathmatch {num} has started!">
                <replacements>
                    <decimal id="num" value="round_deathmatch"/>
                </replacements>
            </message>
        </action>
        <action filter="not(count-xs)">
            <message text="`e» The TNT has been released to `c{num} `eplayers!">
                <replacements>
                    <decimal id="num" value="tmp"/>
                </replacements>
            </message>
        </action>
        <action filter="count-xs">
            <message text="`e» The TNT has been released to `c{num} `eplayer!">
                <replacements>
                    <decimal id="num" value="tmp"/>
                </replacements>
            </message>
        </action>
        <switch-scope inner="player" filter="participating">
            <message text=" "/>
            <action filter="is_tnt=1">
                <message text="`c» You have started as TNT! Tag someone quickly!"/>
            </action>
            <action filter="is_tnt=0">
                <message text="`a» Run away from the TNT!"/>
            </action>
        </switch-scope>
        <message text=" "/>
    </action>
    <!--
      Rounds
    -->
    <trigger scope="match" filter="round-idle-end">
        <action>
            <set var="round_state" value="1"/>
        </action>
    </trigger>
    <trigger scope="match" filter="round-starting">
        <action>
            <action id="pick-next-tnt"/>
            <set var="round" value="round+1"/>
            <set var="round_state" value="2"/>
        </action>
    </trigger>
    <trigger scope="match" filter="round-begin">
        <action>
            <action filter="any(count-xs, count-sm)">
                <set var="round_deathmatch" value="round_deathmatch+1"/>
            </action>
            <set var="tnt_fuse" value="100"/>
            <action id="distribute-tnt-kits"/>
            <action id="round-begin-message"/>
        </action>
    </trigger>
    <trigger scope="match" filter="round-end">
        <action>
            <set var="round_state" value="0"/>
            <sound key="random.explode"/>
            <switch-scope inner="player" filter="all(is_tnt=1, participating)">
                <kit id="tnt-kill"/>
            </switch-scope>
        </action>
    </trigger>
    <!--
      Attacking/Kits
    -->
    <action id="become-tnt" scope="player">
        <set var="is_tnt" value="1"/>
        <kit id="tnt-kit"/>
        <sound key="mob.creeper.say" volume="0.5" pitch="1.5"/>
        <message text="`cYou have been tagged!"/>
    </action>
    <action id="become-hider" scope="player">
        <set var="is_tnt" value="0"/>
        <kit id="hider-kit"/>
        <message text="`aYou tagged another player!"/>
    </action>
    <trigger scope="match" filter="start-tnt-fuse">
        <action>
            <sound key="game.tnt.primed"/>
        </action>
    </trigger>
    <trigger scope="match">
        <filter>
            <pulse period="0.5s" duration="0.25s" filter="start-tnt-fuse"/>
        </filter>
        <action>
            <set var="tnt_fuse" value="tnt_fuse-1"/>
            <set var="tmp" value="tnt_fuse % 2"/>
            <action filter="tmp=0">
                <sound key="random.fizz" volume="0.5"/>
                <switch-scope inner="player" filter="all(is_tnt=1, participating)">
                    <kit id="tnt-flash-kit"/>
                </switch-scope>
            </action>
            <action filter="not(tmp=0)">
                <switch-scope inner="player" filter="all(is_tnt=1, participating)">
                    <kit id="tnt-kit"/>
                </switch-scope>
            </action>
        </action>
    </trigger>
    <action id="attack-action" scope="player" filter="all(attacker-is-tnt, victim-is-hider)">
        <action id="become-hider"/>
    </action>
    <action id="victim-action" scope="player" filter="all(victim-is-hider)">
        <action id="become-tnt"/>
    </action>
</actions>
<damage attacker-action="attack-action" victim-action="victim-action">
    <deny>
        <any>
            <not>
                <any>
                    <cause>melee</cause>
                    <cause>projectile</cause>
                    <cause>potion</cause>
                </any>
            </not>
            <all>
                <attacker>
                    <variable var="is_tnt">0</variable>
                </attacker>
                <victim>
                    <variable var="is_tnt">0</variable>
                </victim>
            </all>
        </any>
    </deny>
</damage>
<itemremove>
    <item>tnt</item>
    <item>snow block</item>
    <item>leather chestplate</item>
    <item>leather leggings</item>
    <item>leather boots</item>
</itemremove>
<hunger>
    <depletion>off</depletion>
</hunger>
</map>
