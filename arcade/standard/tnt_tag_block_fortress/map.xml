<map proto="1.4.2">
<name>TNT Tag: Block Fortress</name>
<version>1.0.0</version>
<objective>Survive the TNT onslaught!</objective>
<gamemode>arcade</gamemode>
<gamemode>ffa</gamemode>
<authors>
    <author uuid="2a289d2a-d970-49c5-9a6c-01fc0264e317"/> <!-- Stealth5061 -->
    <author uuid="ef4ea031-998f-4ec9-b7b6-1bdd428bcef8"/> <!-- Plastix -->
</authors>
<contributors>
    <contributor uuid="f690a591-348b-482e-a18d-7779d0c0a28c" contribution="TNT Tag XML"/> <!-- mitchiii -->
</contributors>
<time>5m</time>
<blitz/>
<players max="64"/>
<kits>
    <kit id="tnt-kit" force="true">
        <helmet material="tnt" locked="true"/>
        <chestplate material="leather chestplate" color="993333" locked="true" unbreakable="true"/>
        <leggings material="leather leggings" color="993333" locked="true" unbreakable="true"/>
        <boots material="leather boots" color="993333" locked="true" unbreakable="true"/>
        <item slot="0" material="tnt" locked="true"/>
        <item slot="1" material="tnt" locked="true"/>
        <item slot="2" material="tnt" locked="true"/>
        <item slot="3" material="tnt" locked="true"/>
        <item slot="4" material="compass"/>
        <item slot="5" material="tnt" locked="true"/>
        <item slot="6" material="tnt" locked="true"/>
        <item slot="7" material="tnt" locked="true"/>
        <item slot="8" material="tnt" locked="true"/>
        <effect amplifier="127">resistance</effect>
        <effect>speed</effect>
    </kit>
    <kit id="tnt-flash-kit" force="true">
        <helmet material="snow block" name="`rTNT" locked="true"/>
        <chestplate material="leather chestplate" color="ffffff" locked="true" unbreakable="true"/>
        <leggings material="leather leggings" color="ffffff" locked="true" unbreakable="true"/>
        <boots material="leather boots" color="ffffff" locked="true" unbreakable="true"/>
        <item slot="0" material="snow block" name="`rTNT" locked="true"/>
        <item slot="1" material="snow block" name="`rTNT" locked="true"/>
        <item slot="2" material="snow block" name="`rTNT" locked="true"/>
        <item slot="3" material="snow block" name="`rTNT" locked="true"/>
        <item slot="4" material="compass"/>
        <item slot="5" material="snow block" name="`rTNT" locked="true"/>
        <item slot="6" material="snow block" name="`rTNT" locked="true"/>
        <item slot="7" material="snow block" name="`rTNT" locked="true"/>
        <item slot="8" material="snow block" name="`rTNT" locked="true"/>
        <effect amplifier="127">resistance</effect>
        <effect>speed</effect>
    </kit>
    <kit id="tnt-kill" force="true">
        <clear effects="true"/>
        <effect amplifier="50">instant damage</effect>
    </kit>
    <kit id="hider-kit">
        <clear effects="true"/>
        <effect amplifier="127">resistance</effect>
    </kit>
</kits>
<compass show-distance="true">
    <player filter="is_tnt=0" show-player="true"/>
</compass>
<spawns>
    <spawn spread="true" safe="true">
        <regions>
            <cuboid min="32,3,-32" max="-32,14,32"/>
        </regions>
    </spawn>
    <default yaw="180">
        <regions>
            <cuboid min="-2,23,-48" max="2,23,-52"/>
        </regions>
    </default>
</spawns>
<filters>
    <match-started id="match-started"/>
    <participating id="participating"/>
    <observing id="observing"/>
    <after id="round-1-begin" duration="10s" message="Round 1 begins in {0}">
        <time id="round-1-starting">0s</time>
    </after>
    <after id="round-2-begin" duration="10s" message="Round 2 begins in {0}">
        <time id="round-2-starting">1m</time>
    </after>
    <after id="round-3-begin" duration="10s" message="Round 3 begins in {0}">
        <time id="round-3-starting">2m</time>
    </after>
    <after id="round-4-begin" duration="10s" message="Round 4 begins in {0}">
        <time id="round-4-starting">3m</time>
    </after>
    <after id="round-5-begin" duration="10s" message="Round 5 begins in {0}">
        <time id="round-5-starting">4m</time>
    </after>
    <players id="count-xs" filter="participating" max="5"/>
    <players id="count-sm" filter="participating" min="6" max="14"/>
    <players id="count-md" filter="participating" min="15" max="29"/>
    <players id="count-lg" filter="participating" min="30" max="39"/>
    <players id="count-xl" filter="participating" min="40"/>
    <attacker id="attacker-is-tnt">
        <variable id="is-tnt" var="is_tnt">1</variable>
    </attacker>
    <victim id="victim-is-hider">
        <variable id="is-hider" var="is_tnt">0</variable>
    </victim>
</filters>
<variables scope="player">
    <variable id="start_tnt_xs" exclusive="1"/>
    <variable id="start_tnt_sm" exclusive="2"/>
    <variable id="start_tnt_md" exclusive="3"/>
    <variable id="start_tnt_lg" exclusive="5"/>
    <variable id="start_tnt_xl" exclusive="7"/>
    <variable id="is_tnt" default="0"/>
    <variable id="tnt_fuse" default="0" scope="match"/>
    <variable id="tmp" default="0" scope="match"/>
    <variable id="round_num" default="0" scope="match"/>
</variables>
<actions>
    <!--
      Utils
    -->
    <action id="pick-next-tnt" scope="match">
        <switch-scope inner="player" filter="participating">
            <set var="start_tnt_xs" value="1"/>
            <set var="start_tnt_sm" value="1"/>
            <set var="start_tnt_md" value="1"/>
            <set var="start_tnt_lg" value="1"/>
            <set var="start_tnt_xl" value="1"/>
        </switch-scope>
    </action>
    <action id="distribute-tnt-kits" scope="match">
        <action filter="count-xs">
            <set var="tmp" value="1"/>
        </action>
        <action filter="count-sm">
            <set var="tmp" value="2"/>
        </action>
        <action filter="count-md">
            <set var="tmp" value="3"/>
        </action>
        <action filter="count-lg">
            <set var="tmp" value="5"/>
        </action>
        <action filter="count-xl">
            <set var="tmp" value="7"/>
        </action>
        <switch-scope inner="player" filter="participating">
            <action filter="any(all(count-xs, start_tnt_xs=1), all(count-sm, start_tnt_sm=1), all(count-md, start_tnt_md=1), all(count-lg, start_tnt_lg=1), all(count-xl, start_tnt_xl=1))">
                <action id="become-tnt"/>
            </action>
        </switch-scope>
    </action>
    <action id="round-start-message" scope="match">
        <message text=" "/>
        <message text="`b`l» Round {num} has started!">
            <replacements>
                <decimal id="num" value="round_num"/>
            </replacements>
        </message>
        <message text="`e» The TNT has been released to `c{num} `eplayers!">
            <replacements>
                <decimal id="num" value="tmp"/>
            </replacements>
        </message>
        <switch-scope inner="player" filter="participating">
            <message text=" "/>
            <action filter="is_tnt=1">
                <message text="`c» You have started as TNT! Tag someone quickly!"/>
            </action>
            <action filter="is_tnt=0">
                <message text="`a» You did not start as TNT! Run away!"/>
            </action>
        </switch-scope>
        <message text=" "/>
    </action>
    <!--
      Rounds
    -->
    <trigger scope="match" filter="round-1-starting" action="pick-next-tnt"/>
    <trigger scope="match" filter="round-1-begin">
        <action>
            <set var="round_num" value="1"/>
            <set var="tnt_fuse" value="92"/>
            <action id="distribute-tnt-kits"/>
            <action id="round-start-message"/>
        </action>
    </trigger>
    <trigger scope="match" filter="round-2-starting" action="pick-next-tnt"/>
    <trigger scope="match" filter="round-2-begin">
        <action>
            <set var="round_num" value="2"/>
            <set var="tnt_fuse" value="92"/>
            <action id="distribute-tnt-kits"/>
            <action id="round-start-message"/>
        </action>
    </trigger>
    <trigger scope="match" filter="round-3-starting" action="pick-next-tnt"/>
    <trigger scope="match" filter="round-3-begin">
        <action>
            <set var="round_num" value="3"/>
            <set var="tnt_fuse" value="92"/>
            <action id="distribute-tnt-kits"/>
            <action id="round-start-message"/>
        </action>
    </trigger>
    <trigger scope="match" filter="round-4-starting" action="pick-next-tnt"/>
    <trigger scope="match" filter="round-4-begin">
        <action>
            <set var="round_num" value="4"/>
            <set var="tnt_fuse" value="92"/>
            <action id="distribute-tnt-kits"/>
            <action id="round-start-message"/>
        </action>
    </trigger>
    <trigger scope="match" filter="round-5-starting" action="pick-next-tnt"/>
    <trigger scope="match" filter="round-5-begin">
        <action>
            <set var="round_num" value="5"/>
            <set var="tnt_fuse" value="92"/>
            <action id="distribute-tnt-kits"/>
            <action id="round-start-message"/>
        </action>
    </trigger>
    <!--
      Attacking/Kits
    -->
    <action id="become-tnt" scope="player">
        <set var="is_tnt" value="1"/>
        <kit id="tnt-kit"/>
        <sound key="mob.creeper.say" volume="0.5" pitch="1.5"/>
        <message text="`cYou have been tagged!"/>
    </action>
    <action id="become-hider" scope="player">
        <set var="is_tnt" value="0"/>
        <kit id="hider-kit"/>
        <message text="`aYou tagged another player!"/>
    </action>
    <trigger scope="player">
        <filter>
            <pulse period="1s" duration="0.25s" filter="not(tnt_fuse=0)"/>
        </filter>
        <action>
            <message actionbar="`aTNT explodes in {num} seconds!">
                <replacements>
                    <decimal id="num" value="tnt_fuse/2"/>
                </replacements>
            </message>
        </action>
    </trigger>
    <trigger scope="match">
        <filter>
            <pulse period="0.5s" duration="0.25s" filter="tnt_fuse=1.."/>
        </filter>
        <action>
            <set var="tnt_fuse" value="tnt_fuse-1"/>
            <action filter="tnt_fuse=1..20">
                <set var="tmp" value="tnt_fuse % 2"/>
                <action filter="tnt_fuse=20">
                    <sound key="game.tnt.primed"/>
                </action>
                <action filter="tmp=0">
                    <sound key="random.fizz"/>
                    <switch-scope inner="player" filter="all(is_tnt=1, participating)">
                        <kit id="tnt-flash-kit"/>
                    </switch-scope>
                </action>
                <action filter="not(tmp=0)">
                    <switch-scope inner="player" filter="all(is_tnt=1, participating)">
                        <kit id="tnt-kit"/>
                    </switch-scope>
                </action>
            </action>
        </action>
    </trigger>
    <trigger scope="match" filter="tnt_fuse=0">
        <action>
            <sound key="random.explode"/>
            <switch-scope inner="player" filter="all(is_tnt=1, participating)">
                <kit id="tnt-kill"/>
            </switch-scope>
        </action>
    </trigger>
    <action id="attack-action" scope="player" filter="all(attacker-is-tnt, victim-is-hider)">
        <action id="become-hider"/>
    </action>
    <action id="victim-action" scope="player" filter="all(victim-is-hider)">
        <action id="become-tnt"/>
    </action>
</actions>
<damage attacker-action="attack-action" victim-action="victim-action">
    <deny>
        <any>
            <not>
                <any>
                    <cause>melee</cause>
                    <cause>projectile</cause>
                    <cause>potion</cause>
                </any>
            </not>
            <all>
                <attacker>
                    <variable var="is_tnt">0</variable>
                </attacker>
                <victim>
                    <variable var="is_tnt">0</variable>
                </victim>
            </all>
        </any>
    </deny>
</damage>
<itemremove>
    <item>tnt</item>
    <item>snow block</item>
    <item>leather chestplate</item>
    <item>leather leggings</item>
    <item>leather boots</item>
</itemremove>
<hunger>
    <depletion>off</depletion>
</hunger>
</map>
